---
layout: post
title:  Parsing ISO8583 messages with PHP
summary: Recently I've needed a PHP library to pack and unpack ISO8583 formatted messages, but there seems to be very few around. I got frustrated, and so created my own.
---

At work recently we've needed some way to easily pack and unpack ISO8583 formatted messages to integrate with PayPoint. You might assume there would be an abundance of open-source packages, right? Wrong. There is very, very few.

That said, we did end up using one of the few we found. We used [miome/iso8583](https://github.com/m1ome/iso8583/). His library takes a hexadecimal ISO8583 formatted string and parses it to a numeric array of data, where the array index is the bit the data corresponds to. Simple, right? Our application needed more, though. We needed a way to easily set this data into a useful, accessible, schema class. Our application also had to know which properties were set on the schema class and keep track of the formats and types in preparation for forwarding the data to our API.

In the end, we built `FinanceMessageBuilder` and `FinanceMessageManager` classes that were responsible for; taking the numeric array and setting the data into the schema class based on a json cache file that was generated by reading the schema property annotations, and keeping track of the properties set on the schema class. This worked, but wasn't ideal.

To me, this could have all been one library. All the code is concerned with the same goal, so why not? This, combined with my general frustration of not being able to find a library that did what I wanted, motivated me to write a new financial message parsing library.

## Message Parsing

```php
$schema = new ISO8583();

$cacheManager = new CacheManager();
$cacheManager->generateSchemaCache($schema);

/** @var ISO8583 $schemaManager */
$schemaManager = new SchemaManager($schema, $cacheManager);

/** @var MessageUnpacker $message */
$message = (new Financial($cacheManager))->unpack($schemaManager);

$message->setHeaderLength(2);
$parsedMessage = $message->parse("012430323030f23e4491a8e08020000000000000002031362a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a303030303030303030303030303031303030313231323134353430383030303030393134353430383132313231373033313231333030303039303230304330303030303030303036303030303230303630303030323033372a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a2a504652333437303030303039323837353937353830303030303030303030333039333733303134373430342054657374204167656e74203220204861746669656c64202020202048654742383236303238303030303030323136317c303030307c504652333437303030303039303135353630313031323634303243313031");

/** @var ISO8583 $schema */
$parsedSchema = $parsedMessage->getParsedSchema();

echo $parsedMessage->getMti();
echo $parsedSchema->getCardAcceptorNameLocation();
```

Above is an example of how my library parses ISO8583 messages. You'll notice we have an ISO8583 class - the schema. The schema class is responsible for defining the mappings between the numerical bit => data array and schema properties. The schema also provides getters for each of the properties. The schema class isn't accessible directly, though. All interaction with the schema should be directed through the `SchemaManager`. The `SchemaManager` is responsible for validating data to be set on schema properties and keeping track of properties set.
